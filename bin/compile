#!/bin/bash
# Usage: bin/compile BUILD_DIR CACHE_DIR ENV_DIR

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

VERSION="24.5"
EMACS_SOURCE_URL="http://ftp.jaist.ac.jp/pub/GNU/emacs/emacs-$VERSION.tar.gz"

VENDOR_DIR=$BUILD_DIR/.heroku/vendor

indent() {
  sed -u 's/^/       /'
}

echo "BEGIN buildpack compile [$*]" | indent

echo "-----> Build & Install Emacs" | indent

curl -L --silent $EMACS_SOURCE_URL | tar xz
cd emacs-$VERSION
./configure --without-all --without-x --prefix=$VENDOR_DIR | indent
make | indent
make install | indent

# Transfer binary to other server
tar czvf $BUILD_DIR/emacs-$VERSION-heroku-bin.tar.gz $VENDOR_DIR
# scp $BUILD_DIR/$EMACS_VERSIO-heroku-bin.tar.gz {{$MY_SERVER}}

echo "...done" | indent
